function _interopDefault(ex) {
  return ex && "object" == typeof ex && "default" in ex ? ex.default : ex;
}

function _extends() {
  return (_extends = Object.assign || function(target) {
    var i, source, key;
    for (i = 1; i < arguments.length; i++) {
      source = arguments[i];
      for (key in source) {
        if (Object.prototype.hasOwnProperty.call(source, key)) {
          target[key] = source[key];
        }
      }
    }
    return target;
  }).apply(this, arguments);
}

function resetClient() {
  urqlClient = null;
}

function _ref() {
  return null;
}

function initUrqlClient(clientOptions, canEnableSuspense) {
  var isServer = "undefined" == typeof window;
  if (isServer || !urqlClient) {
    (urqlClient = urql.createClient(_extends({}, clientOptions, {
      suspense: canEnableSuspense && (isServer || clientOptions.suspense)
    }))).toJSON = _ref;
  }
  return urqlClient;
}

var ssr, React = require("react"), React__default = _interopDefault(React), ssrPrepass = _interopDefault(require("react-ssr-prepass")), urql = require("urql"), urqlClient = null;

exports.withUrqlClient = function withUrqlClient(getClientConfig, options) {
  if (!options) {
    options = {};
  }
  return function(AppOrPage) {
    var shouldBindGetInitialprops = Boolean(AppOrPage.getInitialProps || options.ssr), withUrql = function(ref) {
      var urqlClient = ref.urqlClient, urqlState = ref.urqlState, rest$1 = function objectWithoutProperties(obj, exclude) {
        var k, target = {};
        for (k in obj) {
          if (Object.prototype.hasOwnProperty.call(obj, k) && -1 === exclude.indexOf(k)) {
            target[k] = obj[k];
          }
        }
        return target;
      }(ref, [ "urqlClient", "urqlState" ]), rest = rest$1, forceUpdate = React.useState(0), client = React__default.useMemo((function() {
        if (urqlClient) {
          return urqlClient;
        }
        if (!ssr || "undefined" == typeof window) {
          ssr = urql.ssrExchange({
            initialState: urqlState
          });
        }
        var clientConfig = getClientConfig(ssr);
        if (!clientConfig.exchanges) {
          clientConfig.exchanges = [ urql.dedupExchange, urql.cacheExchange, ssr, urql.fetchExchange ];
        }
        return initUrqlClient(clientConfig, shouldBindGetInitialprops);
      }), [ urqlClient, urqlState, forceUpdate[0] ]), resetUrqlClient = function() {
        resetClient();
        ssr = urql.ssrExchange({
          initialState: void 0
        });
        forceUpdate[1](forceUpdate[0] + 1);
      };
      return React__default.createElement(urql.Provider, {
        value: client
      }, React__default.createElement(AppOrPage, _extends({
        urqlClient: client,
        resetUrqlClient: resetUrqlClient
      }, rest)));
    };
    withUrql.displayName = "withUrqlClient(" + function getDisplayName(Component) {
      return Component.displayName || Component.name || "Component";
    }(AppOrPage) + ")";
    if (shouldBindGetInitialprops) {
      withUrql.getInitialProps = function _ref4(appOrPageCtx) {
        function _ref() {
          return _extends({}, pageProps, {
            urqlState: ssrCache ? ssrCache.extractData() : void 0,
            urqlClient: urqlClient
          });
        }
        function _temp2() {
          var props;
          if ("undefined" != typeof window) {
            return _extends({}, pageProps, {
              urqlClient: urqlClient
            });
          }
          props = _extends({}, pageProps, {
            urqlClient: urqlClient
          });
          return Promise.resolve(ssrPrepass(React__default.createElement(AppTree, _extends({}, isApp ? props : {
            pageProps: props
          })))).then(_ref);
        }
        function _ref2(_AppOrPage$getInitial) {
          pageProps = _AppOrPage$getInitial;
        }
        var AppTree, isApp, ctx, ssrCache, clientConfig, urqlClient, pageProps;
        try {
          AppTree = appOrPageCtx.AppTree;
          ctx = (isApp = !!appOrPageCtx.Component) ? appOrPageCtx.ctx : appOrPageCtx;
          ssrCache = urql.ssrExchange({
            initialState: void 0
          });
          if (!(clientConfig = getClientConfig(ssrCache, ctx)).exchanges) {
            clientConfig.exchanges = [ urql.dedupExchange, urql.cacheExchange, ssrCache, urql.fetchExchange ];
          }
          if (urqlClient = initUrqlClient(clientConfig, !0)) {
            ctx.urqlClient = urqlClient;
          }
          pageProps = {};
          const _temp = function _ref3() {
            if (AppOrPage.getInitialProps) {
              return Promise.resolve(AppOrPage.getInitialProps(appOrPageCtx)).then(_ref2);
            }
          }();
          return Promise.resolve(_temp && _temp.then ? _temp.then(_temp2) : _temp2());
        } catch (e) {
          return Promise.reject(e);
        }
      };
    }
    return withUrql;
  };
};
//# sourceMappingURL=next-urql.js.map
